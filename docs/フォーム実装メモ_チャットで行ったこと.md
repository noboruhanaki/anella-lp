# フォーム実装メモ（このチャットで行ったこと）

このドキュメントは、LP お問い合わせフォームの設計〜実装〜修正まで、チャットで行った内容を忘れないようにまとめたものです。

---

## 1. 実装した流れ（全体）

- **フォーム送信** → Next.js API (`/api/contact`) に POST
- API 内で **並列** に以下を実行:
  1. **Gmail** … Resend で `anella.kawasaki@gmail.com` にメール送信
  2. **Chatwork** … Chatwork API で指定ルームにメッセージ投稿（即時通知・架電用）
  3. **スプレッドシート** … 1行追記（任意。Apps Script または Sheets API）

メールと Chatwork のどちらかが成功すればフォームは「成功」として扱い、スプレッドシートだけ失敗した場合は 200 のまま `sheetError` をレスポンスに含めてフロントでトースト表示。

---

## 2. 変更・追加したファイル一覧

| ファイル | 内容 |
|----------|------|
| `app/api/contact/route.ts` | 新規。POST で JSON 受信 → Resend / Chatwork / スプレッドシート（Apps Script または Sheets API） |
| `components/contact-form-section.tsx` | 送信先を `/api/contact` に変更。送信中ローディング・二重送信防止・成功/失敗トースト・`sheetError` 時は警告トースト |
| `app/layout.tsx` | Sonner の `<Toaster />` を追加（トースト表示用） |
| `.env.example` | Resend / Chatwork / スプレッドシート用の環境変数サンプル |
| `docs/FORM_SUBMISSION_DESIGN.md` | 新規。フォーム送信フローの設計（Gmail・Sheet・Chatwork の役割、案A/B） |
| `docs/GOOGLE_SHEETS_SETUP.md` | 新規。スプレッドシート追記の設定手順（サービスアカウント方式・Apps Script 方式） |
| `README.md` | フォームの説明と環境変数一覧を追記 |
| `package.json` | `resend` と `googleapis` を追加 |

---

## 3. 環境変数（本番・開発で必要なもの）

- **必須（フォーム送信を動かす）**
  - `RESEND_API_KEY` … Resend の API キー
  - `CHATWORK_API_TOKEN` … Chatwork API トークン
  - `CHATWORK_ROOM_ID` … 通知先ルーム ID（URL の `#!rid123456789` の数字部分）
- **任意**
  - `CONTACT_EMAIL_TO` … 申込を受け取るメール（未設定時は anella.kawasaki@gmail.com）
  - `CONTACT_EMAIL_FROM` … 送信元表示
- **スプレッドシート（どちらか一方）**
  - **Apps Script 方式（キー不要）:** `GOOGLE_APPS_SCRIPT_WEB_URL` に GAS のウェブアプリ URL
  - **サービスアカウント方式:** `GOOGLE_SHEET_ID` / `GOOGLE_SHEET_NAME` / `GOOGLE_SERVICE_ACCOUNT_JSON`

---

## 4. スプレッドシートまわりでやったこと

### 4.1 構成（列）

- **A〜E:** 日時・お名前・電話番号・メール・ご希望・ご質問（フォームから自動追記）
- **F:** 進捗（ステータス）。スタッフが「未架電」「架電済」などを手で入力。データの入力規則でリスト化可能。A〜E はロックしてスタッフが触らないようにする想定。

### 4.2 電話番号の先頭 0 が消える問題

- スプレッドシートは数字として入ると先頭の 0 が消えるため、**文字列**で保存するようにした。
- **対応:** 書き込む直前に `"'" + phone` のようにシングルクォートを付与（表示上は 0 からそのまま見える）。

### 4.3 F列だけ埋まっている行で追記が飛ぶ問題

- もともと `appendRow()` を使っていたため、「シートのいちばん下の行」に追記され、F列だけ「未架電」などが入った行があると、その下（例: 15 行目）に書かれていた。
- **対応:** 「**A 列にデータがある最後の行**」を求め、その **次の行** にだけ `setValues()` で追記するように変更。F 列だけ埋まった行は無視する。

### 4.4 setValues の「行数が合わない」エラー

- `getRange(nextRow, 1, nextRow, 6)` と書いていたが、GAS の `getRange(row, col, 〇, 〇)` の第 3・4 引数は **終了行・終了列ではなく「行数・列数」**。
- そのため「3 行の範囲」と解釈され、「データは 1 行なのに範囲は 3 行」というエラーになっていた。
- **対応:** `getRange(nextRow, 1, 1, 6)` に変更（1 行 × 6 列の範囲）。

### 4.5 組織ポリシーでサービスアカウントキーが作れない場合

- 「サービスアカウントキーの作成が無効」となる環境向けに、**Google Apps Script 方式**を用意。
- スプレッドシートに紐づいた GAS を「ウェブアプリ」としてデプロイし、その URL に POST するだけ。キー不要。`GOOGLE_APPS_SCRIPT_WEB_URL` を設定するとこちらが使われる。

### 4.6 GAS が 200 で HTML のエラーページを返す問題

- スタンドアロンの GAS だと `getActiveSpreadsheet()` が使えずエラーになり、GAS が HTML のエラーページを返すことがあった。
- **対応:** スプレッドシート ID を定数で持ち、`SpreadsheetApp.openById(SPREADSHEET_ID)` で開く。POST body がない場合のチェックと、エラー時も必ず JSON で返す `jsonResponse()` を用意。

### 4.7 コードブロックをそのまま貼ると「javascript is not defined」

- ドキュメントの `` ```javascript `` や `` ``` `` をそのまま GAS に貼ると、先頭の `javascript` がコードとして実行されエラーになる。
- **対応:** ドキュメントに「\`\`\` の行はコピーしないこと」と明記。貼るのは `function doPost` から最後の `}` までだけ。

---

## 5. GAS のコードで押さえておくこと（要約）

- 先頭で `var SPREADSHEET_ID = "あなたのスプレッドシートID";`
- `doPost(e)` で `e.postData.contents` を JSON パース。電話は `"'" + String(phone)` で文字列として保存。
- A 列を上から走査し、「値が入っている最後の行」の次の行を求める。`getRange(nextRow, 1, 1, 6).setValues([[日時, 名前, 電話, メール, 質問, ""]])` で 1 行だけ書き込む。
- 返却は必ず `ContentService.createTextOutput(JSON.stringify(...)).setMimeType(ContentService.MimeType.JSON)` で JSON。

---

## 6. 本番環境でエラーになる理由と対処（別チャットで整理した内容）

**状況:** ローカルではフォーム送信が成功するが、本番（a-melo.com/anella-work-b/）では送信するとエラーになる。

### 6.1 なぜ本番だけ失敗するか

- **本番の LP は Xサーバーに「静的ファイル（HTML/JS/CSS）だけ」置いている。**
- Node.js は動いていないので、**`/api/contact` という API は本番サーバー上に存在しない。**
- フォームは「同じドメインの `/api/contact`（または basePath 付きで `/anella-work-b/api/contact`）」に送ろうとする → 本番では 404 や 5xx になり、送信失敗となる。

→ つまり「実装は正しいが、本番には API を動かす場所がない」ことが原因。

### 6.2 本番で動かすために必要なこと（やることの要点だけ）

1. **フォームの送信先を「本番で動いている API」に変える**
   - 本番用にビルドするとき、**`NEXT_PUBLIC_CONTACT_API_URL`** に「実際に API が動いている URL」を指定する。
   - 例: Vercel に API 用でデプロイしているなら  
     `https://あなたのプロジェクト.vercel.app/anella-work-b/api/contact`

2. **API をどこかで動かす**
   - **Vercel** に同じリポジトリをデプロイし、環境変数（RESEND / Chatwork 等）を設定する。  
     ※ Vercel では **`BUILD_STATIC` を設定しない**（設定すると API が含まれず動かない）。  
     `NEXT_PUBLIC_BASE_PATH=/anella-work-b` は設定する。
   - または **Google Apps Script** の Web アプリをフォーム送信先にする（GAS 側でメール・Chatwork・Sheet を実装する必要あり）。

3. **Xサーバー用のビルドでは「送信先 URL」と「静的エクスポート」を指定する**
   - ビルドコマンド例:  
     `BUILD_STATIC=1 NEXT_PUBLIC_BASE_PATH=/anella-work-b NEXT_PUBLIC_CONTACT_API_URL=https://(Vercelのドメイン)/anella-work-b/api/contact npm run build`
   - できた **`out`** の中身を Xサーバーの **`anella-work-b`** にアップロードする。

### 6.3 本番で「404 Not Found」が出るとき（送信先は Vercel の URL なのに）

- **症状:** Request URL が `https://anella-lp.vercel.app/anella-work-b/api/contact` で、Status Code が **404 Not Found**（OPTIONS や POST のどちらも 404 の場合あり）。
- **原因（候補）:** (1) Vercel で **`NEXT_PUBLIC_BASE_PATH`** 未設定のため API が `/api/contact` にしかない、(2) ビルドキャッシュで古い設定のまま、(3) basePath 付きで API が正しく動いていない。
- **確実な対処（basePath を使わない方法）:**  
  Vercel では **basePath を使わず**、API を **ルートの `/api/contact`** で動かし、フォームの送信先だけその URL に合わせる。
  1. **Vercel** → **Settings** → **Environment Variables** で **`NEXT_PUBLIC_BASE_PATH` を削除**する（あれば）。**`BUILD_STATIC`** も存在したら削除。
  2. **Deployments** → 直近の **⋯** → **Redeploy** で再デプロイする。
  3. 再デプロイ後、API の URL は **`https://anella-lp.vercel.app/api/contact`** になる。
  4. **Xサーバー用の LP を、この URL 向けにビルドし直す**（下記コマンド）。できた **`out`** を Xサーバーの **`anella-work-b`** に再アップロードする。
     ```bash
     cd /Users/hanakinoboru/Desktop/anella-lp
     BUILD_STATIC=1 NEXT_PUBLIC_BASE_PATH=/anella-work-b NEXT_PUBLIC_CONTACT_API_URL=https://anella-lp.vercel.app/api/contact npm run build
     ```
  5. 本番のフォームから再度送信して確認する。

※ **`BUILD_STATIC`** は Vercel では **設定しない**（設定すると API が含まれず、同じく 404 になる）。

### 6.4 本番でエラーが出たときに確認すること（一覧）

| 確認項目 | 内容 |
|----------|------|
| 本番のフォームはどこに送っているか | ビルド時に `NEXT_PUBLIC_CONTACT_API_URL` を指定したか。指定していないと「同じドメインの /api/contact」に送り、本番では存在しないので失敗する。 |
| 送信先が Vercel なのに 404 | Vercel に `NEXT_PUBLIC_BASE_PATH=/anella-work-b` を設定し、Redeploy したか（未設定だと API は `/api/contact` のみで `/anella-work-b/api/contact` は存在しない）。 |
| API は本当に動いているか | ブラウザや curl で `NEXT_PUBLIC_CONTACT_API_URL` に POST して、200 で `{"success":true}` が返るか確認する。 |
| Vercel の環境変数 | `RESEND_API_KEY` または `CHATWORK_*` が設定され、Redeploy 済みか。 |

※ 詳細な手順は `docs/本番フォームを動かす手順_ひとつずつ.md` や `docs/本番デプロイ時の注意.md` を参照。

---

## 7. 関連ドキュメント

- フロー設計・案 A/B の説明 … `docs/FORM_SUBMISSION_DESIGN.md`
- スプレッドシートの設定手順（サービスアカウント・Apps Script・進捗列の使い方） … `docs/GOOGLE_SHEETS_SETUP.md`
- 環境変数一覧 … `.env.example` および `README.md`
- **本番でフォームを動かす** … `docs/本番フォームを動かす手順_ひとつずつ.md`、`docs/本番デプロイ時の注意.md`、`docs/VERCEL_FORM_API_SETUP.md`

---

*このメモは、チャット内で実施したフォーム周りの実装・修正を振り返るために作成しました。*
