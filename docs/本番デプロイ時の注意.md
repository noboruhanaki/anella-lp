# 本番デプロイ時の注意（忘れがちなポイント）

ローカルでは動くが本番でフォームが動かない・表示がおかしい場合、以下を確認してください。

---

## 本番でフォームを送れるようにする流れ（解決の手順）

1. **Vercel に「API 用」でこのプロジェクトをデプロイする**  
   - GitHub に push → Vercel でインポート → 環境変数を設定（下記）→ デプロイ  
   - ここでは **静的エクスポートは使わない**（Vercel では `BUILD_STATIC` を設定しない）ので、`/anella-work-b/api/contact` が動きます。
2. **Vercel の環境変数**で次を設定する（必須は basePath と RESEND または Chatwork）  
   - `NEXT_PUBLIC_BASE_PATH` = `/anella-work-b`  
   - `RESEND_API_KEY`（必須のうちどれか）、または `CHATWORK_API_TOKEN` + `CHATWORK_ROOM_ID`  
   - 任意: `CONTACT_EMAIL_TO`、Chatwork、`GOOGLE_APPS_SCRIPT_WEB_URL` など  
   - 設定後は **Redeploy** する。
3. **Xサーバー用に静的ビルド**する（自分の PC で実行）  
   - `BUILD_STATIC=1 NEXT_PUBLIC_BASE_PATH=/anella-work-b NEXT_PUBLIC_CONTACT_API_URL=https://あなたのVercelドメイン/anella-work-b/api/contact npm run build`  
   - できた **`out`** を Xサーバーの **`anella-work-b`** にアップロードする。

これで、本番の LP のフォームが Vercel の API に送信され、メール／Chatwork に届きます。  
詳細は **VERCEL_FORM_API_SETUP.md** と **DEPLOY_XSERVER.md** を参照してください。

---

## なぜ本番だと動かないか

- **Xサーバーに置いているのは静的ファイル（HTML/CSS/JS）だけ**です。
- Node が動かないので **`/api/contact` は存在しません**。フォームは「別の URL」に送る必要があります。
- 開発時（`npm run dev`）は Next が API を動かしているので、相対パス `/api/contact` で動きます。

---

## 本番用ビルドで忘れずにやること

### 1. フォーム送信先を「外部 API」に指定する

Xサーバー用にビルドするとき、**必ず** フォーム送信先の URL を渡します。

- **Vercel に API をデプロイしている場合**  
  → `NEXT_PUBLIC_CONTACT_API_URL=https://あなたのプロジェクト.vercel.app/anella-work-b/api/contact`
- **Google Apps Script の Web アプリを使う場合**  
  → `NEXT_PUBLIC_CONTACT_API_URL=https://script.google.com/macros/s/xxxx/exec`

指定しないと、フォームは同じドメインの `/api/contact` に送られ、本番では 404 になります。

### 2. サブディレクトリ用の basePath を指定する

`https://a-melo.com/anella-work-b/` で公開する場合は、ビルド時に **basePath** を指定します。

- **`NEXT_PUBLIC_BASE_PATH=/anella-work-b`** を付けてビルドする。

指定しないと、アセットやリンクがルート `/` 向けになり、本番で画像やスタイルが表示されない・リンクが壊れることがあります。

### 3. 本番用ビルドコマンドの例（まとめ）

```bash
cd /Users/hanakinoboru/Desktop/anella-lp
npm ci

# 次の1行でビルド（Vercel の API を使う場合）
BUILD_STATIC=1 NEXT_PUBLIC_BASE_PATH=/anella-work-b NEXT_PUBLIC_CONTACT_API_URL=https://あなたのVercelドメイン/anella-work-b/api/contact npm run build
```

できた **`out`** の中身を Xサーバーの **`anella-work-b`** にアップロードします。

---

## チェックリスト（本番アップ前）

- [ ] **Vercel** にこのリポジトリをデプロイし、環境変数（`NEXT_PUBLIC_BASE_PATH`・`RESEND_API_KEY`・Chatwork 等）を設定した（**Vercel では BUILD_STATIC を設定しない**）
- [ ] Xサーバー用ビルドで **BUILD_STATIC=1** を付けた
- [ ] ビルド時に **NEXT_PUBLIC_BASE_PATH=/anella-work-b** を付けた
- [ ] ビルド時に **NEXT_PUBLIC_CONTACT_API_URL** に Vercel の API URL を指定した
- [ ] 本番サイトでフォームを送信して、メール／Chatwork に届くか確認した

---

詳細は **DEPLOY_XSERVER.md** と **VERCEL_FORM_API_SETUP.md** を参照してください。
