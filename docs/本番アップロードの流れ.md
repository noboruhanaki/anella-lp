# Cursor でいじった内容を本番にアップロードする流れ

**別のチャットを開いたときでも、このファイルを見れば本番反映の手順がわかるようにまとめています。**

---

## 1. 構成の整理

| 役割 | どこで動く | 説明 |
|------|------------|------|
| **LP（表示）** | Xサーバー（a-melo.com/anella-work-b/） | 静的ファイル（HTML/JS/CSS）だけ。Cursor で編集した「見た目・文言」はここに反映する。 |
| **フォーム送信先（API）** | Vercel（anella-lp.vercel.app） | フォームのデータを受け取り、メール・Chatwork・スプレッドシートに送る。Cursor で編集した「API の処理」はここに反映する。 |

- **LP の更新** … ローカルでビルド → できた `out` を Xサーバーにアップロード
- **API の更新** … コードを GitHub に push → Vercel が自動で再デプロイ（または手動 Redeploy）

---

## 2. Cursor で編集したあと、本番に反映する流れ（チェックリスト）

### 2.1 コードを GitHub に push する（API の変更を Vercel に反映するため）

```bash
cd /Users/hanakinoboru/Desktop/anella-lp
git add .
git commit -m "（変更内容を短く書く）"
git push
```

- push すると **Vercel が自動で再デプロイ**する（数分かかる）
- **API のコード**（例: `app/api/contact/route.ts`）を変えた場合は、これだけで本番の API に反映される
- **LP の見た目だけ**（例: コンポーネントや文言）を変えた場合は、このあと **2.2** も必要

---

### 2.2 Xサーバー用の LP をビルドする（LP の表示を本番に反映するため）

**ターミナルで 1 行実行する。**

```bash
cd /Users/hanakinoboru/Desktop/anella-lp && npm install && BUILD_STATIC=1 NEXT_PUBLIC_BASE_PATH=/anella-work-b NEXT_PUBLIC_CONTACT_API_URL=https://anella-lp.vercel.app/api/contact npm run build
```

- `npm install` は、`node_modules` を入れ直したいときや依存を追加したとき用。問題なければ `npm run build` だけでもよい
- 成功すると **`out`** フォルダができる（中身が本番用の静的ファイル）

---

### 2.3 Xサーバーに `out` の中身をアップロードする

- **アップロードするもの**: `anella-lp/out` の**中身すべて**（`out` フォルダ自体ではない）
- **アップロード先**: Xサーバーの **`public_html/anella-work-b`** の中
- 既存の `anella-work-b` の中身を、新しい `out` の中身で**上書き**する

（FTP やサーバーパネルの「ファイル管理」でアップロード。詳しくは **DEPLOY_XSERVER.md** の「4. ビルド成果物をアップロードする」）

**アップロードでやりがちなミス**
- **❌** `out` フォルダごとアップロードする → **✅** `out` の**中身**（index.html や _next フォルダなど）を `anella-work-b` の**中**に置く
- **❌** `anella-work-b` の横に `out` フォルダができる → **✅** `anella-work-b/index.html` ・ `anella-work-b/_next/` のように、中身が直接 `anella-work-b` に入る

**画像を追加・差し替えた場合**
- 画像は `public/images/` に置いておけば、ビルド時に `out` に自動で含まれます。
- **`out` の中身をすべて**アップロードすれば、`anella-work-b/images/` に新しい画像（例: jikyu400.png, obento.png, kawasaki.png）も一緒に上がります。**`images` フォルダごと**忘れずにアップロードしてください。

---

## 2.4 なぜ「push しただけ」だと本番の LP の見た目が変わらないか

- **本番でユーザーが開いている LP** は **Xサーバー**（a-melo.com/anella-work-b/）に置いてある **静的ファイル** です。
- **Git push** で更新されるのは **Vercel**（フォーム送信 API）だけです。Xサーバー上のファイルは一切更新されません。
- だから **ファーストビューや文言など「LP の見た目」を変えたときは、必ず 2.2（ビルド）と 2.3（Xサーバーへアップロード）までやる**必要があります。

---

## 3. やることの早見表

| 編集したもの | やること |
|--------------|----------|
| **API のコード**（`app/api/contact/route.ts` など） | 2.1 だけ（push → Vercel が再デプロイ） |
| **LP の見た目・文言**（components や app/page.tsx など） | 2.1 → 2.2 → 2.3（push → ビルド → アップロード） |
| **両方** | 2.1 → 2.2 → 2.3 |

### 今回のように「ファーストビュー（ヒーロー）を直した」場合

見た目だけの変更なので、**2.1 はもう済んでいれば OK**。あとは **2.2 と 2.3 を必ずやる**と本番に反映されます。

1. **2.2 ビルド**（ターミナルで 1 行）
   ```bash
   cd /Users/hanakinoboru/Desktop/anella-lp && BUILD_STATIC=1 NEXT_PUBLIC_BASE_PATH=/anella-work-b NEXT_PUBLIC_CONTACT_API_URL=https://anella-lp.vercel.app/api/contact npm run build
   ```
   → 成功したら `out` フォルダができる
2. **2.3 アップロード**
   - ローカルの **`anella-lp/out` の中身すべて** を選択
   - Xサーバーの **`public_html/anella-work-b`** の中に上書きアップロード（`out` フォルダ自体は送らない）
3. ブラウザで **https://a-melo.com/anella-work-b/** を開き、キャッシュを無視して再読み込み（Ctrl+Shift+R または Cmd+Shift+R）して確認

---

## 4. Vercel の環境変数（本番 API が動くために必要なもの）

Vercel の **Settings → Environment Variables** に以下を設定する。**Production** にチェックを入れる。追加・変更したあとは **Redeploy** が必要。

| Key | 説明 | 必須 |
|-----|------|------|
| `RESEND_API_KEY` | Resend の API キー（メール送信用） | メールを使うなら必須 |
| `CHATWORK_API_TOKEN` | Chatwork の API トークン | Chatwork を使うなら必須 |
| `CHATWORK_ROOM_ID` | 通知先ルーム ID（例: 422220692） | Chatwork を使うなら必須 |
| `CONTACT_EMAIL_TO` | 申込を受け取るメール（未設定時は anella.kawasaki@gmail.com） | 任意 |
| `CONTACT_EMAIL_FROM` | 送信元表示（Resend でドメイン認証したアドレス推奨） | 任意 |
| `GOOGLE_APPS_SCRIPT_WEB_URL` | GAS の Web アプリ URL（スプレッドシート追記・キー不要） | スプレッドシートを使うなら |
| `GOOGLE_SHEET_ID` | スプレッドシート ID（サービスアカウント方式のとき） | どちらか一方 |
| `GOOGLE_SHEET_NAME` | シート名（省略時は Sheet1） | 任意 |
| `GOOGLE_SERVICE_ACCOUNT_JSON` | サービスアカウントの JSON を 1 行で | どちらか一方 |

**Vercel では設定しないもの**

- **`BUILD_STATIC`** … 設定すると API が含まれず 404 になる
- **`NEXT_PUBLIC_BASE_PATH`** … 現在は使わず、API はルートの `/api/contact` で運用

---

## 5. ローカル開発の注意

- **開発時**（`npm run dev`）は、環境変数で `NEXT_PUBLIC_BASE_PATH` を付けないので **http://localhost:3000/** で表示される（404 にならない）
- **本番用ビルド時だけ**、コマンドで `NEXT_PUBLIC_BASE_PATH=/anella-work-b` と `NEXT_PUBLIC_CONTACT_API_URL=...` を指定する
- `next.config.ts` で、**Vercel 上では静的エクスポートしない**（`VERCEL=1` のときは API を含める）ようにしている

---

## 6. 本番でよくあるトラブルと確認ポイント

| 症状 | 確認すること |
|------|----------------|
| フォーム送信で「送信に失敗しました」 | Network タブで送信先 URL を確認。`https://anella-lp.vercel.app/api/contact` になっているか。 |
| 送信先が正しいのに 404 | Vercel で `BUILD_STATIC` が入っていないか確認。入っていたら削除して Redeploy。 |
| CORS エラー | API のレスポンスに CORS ヘッダーが付いているか（`app/api/contact/route.ts` で `withCors` を付けているか）。 |
| Chatwork に届かない | Vercel の環境変数に `CHATWORK_API_TOKEN` と `CHATWORK_ROOM_ID` が入っているか。Redeploy したか。 |
| スプレッドシートに追記されない | Vercel の環境変数に `GOOGLE_APPS_SCRIPT_WEB_URL`（または Sheets API 用の 3 つ）が入っているか。ローカルの `.env.local` と同じ値を入れ、Redeploy。 |
| 画像やスタイルが本番で崩れる | Xサーバーで `.htaccess` が `/anella-work-b/` を WordPress に渡していないか。**XSERVER_HTACCESS_WORDPRESS.md** を参照。 |

---

## 7. 参照ドキュメント

- **FV ヒーロー修正と本番アップロード（チャットでやったこと）** … `docs/チャットメモ_FVヒーロー修正と本番アップロード.md`
- **Xサーバーへのアップロード詳細** … `docs/DEPLOY_XSERVER.md`
- **Vercel の初期設定・環境変数** … `docs/VERCEL_FORM_API_SETUP.md`
- **フォーム実装の経緯・本番でエラーになる理由** … `docs/フォーム実装メモ_チャットで行ったこと.md`
- **非エンジニア向けステップ** … `docs/本番フォームを動かす手順_ひとつずつ.md`
- **WordPress と .htaccess** … `docs/XSERVER_HTACCESS_WORDPRESS.md`

---

*Cursor で編集した内容を本番に反映するとき、別チャットでもこのファイルを見れば流れが追えるようにまとめました。*
